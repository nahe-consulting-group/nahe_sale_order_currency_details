<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="report_saleorder_document_inherit" inherit_id="sale.report_saleorder_document">
        <xpath expr="//table[@class='table table-sm o_main_table']/tbody" position="inside">
            <t t-set="currency_rate" t-value="doc.pricelist_id.currency_id.with_context(date=doc.date_order).rate"/>
        </xpath>
        <xpath expr="//td[@name='td_priceunit']" position="inside">
            <span t-field="doc.pricelist_id.currency_id.symbol" />
        </xpath>
        <xpath expr="//td[@name='td_subtotal']" position="inside">
            <span t-field="doc.pricelist_id.currency_id.symbol" />
        </xpath>
         <!-- Pasar la variable "currency_rate" al template "account.document_tax_totals" -->
            <xpath expr="//t[@t-call='account.document_tax_totals']" position="attributes">
                <attribute name="t-set">currency_rate</attribute>
                <attribute name="t-value">currency_rate</attribute>
            </xpath>
        <xpath expr="//div[@name='so_total_summary']" position="after">
            <table class="table table-sm">
                <tr>
                    <td><strong>Tipo de cambio:</strong></td>
                    <td class="text-right">
                        <span t-esc="round(1 / doc.currency_rate, 2) if doc.currency_rate else 'N/A'"/>
                    </td>
                </tr>
            </table>
        </xpath>
    </template>
    <template id="account_document_tax_totals_inherit" inherit_id="account.document_tax_totals">
    <!-- Iterar sobre los subtotales y agregar la columna con el nuevo campo -->
    <xpath expr="//tr[contains(@class, 'o_subtotal')]//td[contains(@class, 'text-right')]" position="after">
        <td class="text-right">
            <span t-esc="subtotal['amount'] / currency_rate" t-options="{'widget': 'monetary', 'display_currency': doc.company_id.currency_id}"/>
        </td>
    </xpath>

    <!-- Agregar el total en la nueva columna -->
    <xpath expr="//tr[contains(@class, 'border-black') and contains(@class, 'o_total')]" position="replace">
        <tr class="border-black o_total">
            <td><strong>Total</strong></td>
            <td class="text-right">
                <span t-esc="tax_totals['formatted_amount_total']"/>
            </td>
            <td class="text-right">
                <span t-esc="tax_totals['amount_total'] / currency_rate" t-options="{'widget': 'monetary', 'display_currency': doc.company_id.currency_id}"/>
            </td>
        </tr>
    </xpath>
</template>

</odoo>

